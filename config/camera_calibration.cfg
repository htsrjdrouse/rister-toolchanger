# Camera Calibration Configuration for Dakash Toolchanger
# Advanced pixel-to-printer coordinate calibration and extruder offset tools

# ================================
# EXTRUDER OFFSET CALIBRATION
# ================================

[gcode_macro CALIBRATE_EXTRUDER_OFFSETS]
description: Interactive extruder offset calibration using camera
gcode:
    {% set bed_center_x = printer.configfile.config.stepper_x.position_max|float / 2 %}
    {% set bed_center_y = printer.configfile.config.stepper_y.position_max|float / 2 %}
    {% set z_height = params.Z|default(0.3)|float %}
    
    M118 ===== EXTRUDER OFFSET CALIBRATION =====
    M118 This macro will help calibrate extruder offsets using the camera
    M118 
    M118 Prerequisites:
    M118 1. Camera must be properly focused and calibrated
    M118 2. Printer must be homed and heated
    M118 3. Camera service must be running
    M118 
    
    # Verify camera is available
    M118 Checking camera state...
    CHECK_CAMERA
    
    # Home all axes
    M118 Homing all axes...
    G28
    
    # Heat bed and extruders
    M118 Heating bed and extruders...
    {% if printer.heater_bed %}
        M140 S60  ; Set bed temperature
        M190 S60  ; Wait for bed
    {% endif %}
    
    M104 S200 T0  ; Heat E0
    M104 S200 T1  ; Heat E1
    M109 S200 T0  ; Wait for E0
    M109 S200 T1  ; Wait for E1
    
    # Start calibration sequence
    EXTRUDER_OFFSET_TEST_SEQUENCE Z={z_height}

[gcode_macro EXTRUDER_OFFSET_TEST_SEQUENCE]
description: Print test pattern for both extruders
gcode:
    {% set z_height = params.Z|default(0.3)|float %}
    {% set bed_center_x = printer.configfile.config.stepper_x.position_max|float / 2 %}
    {% set bed_center_y = printer.configfile.config.stepper_y.position_max|float / 2 %}
    {% set offset_distance = params.OFFSET|default(10)|float %}
    
    # Verify camera is picked up for this operation
    M118 Ensuring camera is on carriage for monitoring...
    VERIFY_CAMERA_PICKED
    
    # Position camera over print area
    M118 Positioning for calibration pattern...
    G90  ; Absolute positioning
    G0 X{bed_center_x} Y{bed_center_y} Z20 F3000
    
    # Start camera stream for monitoring
    CAMERA_STREAM_START
    
    # Print E0 test mark
    M118 Printing E0 test mark...
    T0  ; Select E0
    G0 Z{z_height} F300
    G0 X{bed_center_x - offset_distance} Y{bed_center_y} F3000
    G92 E0  ; Reset extruder
    G1 E2 F300  ; Prime
    G1 X{bed_center_x - offset_distance + 5} E5 F1200  ; Print line
    G1 Z{z_height + 0.5} F300
    
    # Print E1 test mark
    M118 Printing E1 test mark...
    T1  ; Select E1
    G0 X{bed_center_x + offset_distance} Y{bed_center_y} F3000
    G0 Z{z_height} F300
    G92 E0  ; Reset extruder
    G1 E2 F300  ; Prime
    G1 X{bed_center_x + offset_distance + 5} E5 F1200  ; Print line
    G1 Z{z_height + 0.5} F300
    
    # Position camera for viewing
    G0 Z10 F300
    G0 X{bed_center_x} Y{bed_center_y + 30} F3000  ; Move camera to viewing position
    
    # Capture image for analysis
    M118 Capturing calibration image...
    G4 P2000  ; Wait 2 seconds
    CAMERA_CAPTURE_WITH_POSITION
    
    {% set camera_ip = printer["gcode_macro CAMERA_CONFIG"].camera0ip %}
    M118 
    M118 ===== CALIBRATION PATTERN COMPLETE =====
    M118 
    M118 Next steps:
    M118 1. Go to camera web interface: http://{camera_ip}:8080
    M118 2. Enable calibration mode
    M118 3. Set microns per pixel (measure ruler in image)
    M118 4. Click on center of each printed line
    M118 5. Calculate and set new extruder offsets
    M118 6. Run TEST_EXTRUDER_OFFSETS to verify
    M118 

[gcode_macro TEST_EXTRUDER_OFFSETS]
description: Test current extruder offsets by printing overlapping lines
gcode:
    {% set bed_center_x = printer.configfile.config.stepper_x.position_max|float / 2 %}
    {% set bed_center_y = printer.configfile.config.stepper_y.position_max|float / 2 %}
    {% set z_height = params.Z|default(0.3)|float %}
    
    M118 Testing extruder offsets...
    
    # Verify camera state
    CHECK_CAMERA
    
    # Home and heat
    G28
    M104 S200 T0
    M104 S200 T1
    M109 S200 T0
    M109 S200 T1
    
    # Start camera stream
    CAMERA_STREAM_START
    
    G90
    G0 X{bed_center_x} Y{bed_center_y} Z20 F3000
    
    # Print overlapping test lines
    T0
    G0 Z{z_height} F300
    G0 X{bed_center_x - 10} Y{bed_center_y} F3000
    G92 E0
    G1 E2 F300
    G1 X{bed_center_x + 10} E10 F1200
    
    T1
    G0 X{bed_center_x - 10} Y{bed_center_y + 0.4} F3000
    G0 Z{z_height} F300
    G92 E0
    G1 E2 F300
    G1 X{bed_center_x + 10} E10 F1200
    
    G1 Z10 F300
    CAMERA_CAPTURE_WITH_POSITION
    
    M118 Check camera image - lines should be perfectly aligned

[gcode_macro SET_EXTRUDER_OFFSET_FROM_PIXELS]
description: Calculate and set extruder offset based on pixel measurements
gcode:
    {% set e0_pixel_x = params.E0_PIXEL_X|default(0)|float %}
    {% set e0_pixel_y = params.E0_PIXEL_Y|default(0)|float %}
    {% set e1_pixel_x = params.E1_PIXEL_X|default(0)|float %}
    {% set e1_pixel_y = params.E1_PIXEL_Y|default(0)|float %}
    {% set microns_per_pixel = params.MICRONS_PER_PIXEL|default(10)|float %}
    
    # Calculate offset in pixels
    {% set pixel_offset_x = e1_pixel_x - e0_pixel_x %}
    {% set pixel_offset_y = e1_pixel_y - e0_pixel_y %}
    
    # Convert to millimeters
    {% set offset_x_mm = pixel_offset_x * microns_per_pixel / 1000 %}
    {% set offset_y_mm = pixel_offset_y * microns_per_pixel / 1000 %}
    
    # Format the values to 3 decimal places using round()
    {% set offset_x_formatted = (offset_x_mm * 1000)|round|float / 1000 %}
    {% set offset_y_formatted = (offset_y_mm * 1000)|round|float / 1000 %}
    
    M118 Calculated extruder offsets
    M118 E1 X offset {offset_x_formatted}mm
    M118 E1 Y offset {offset_y_formatted}mm
    M118 
    M118 Add these to your printer.cfg
    M118 [extruder_stepper extruder1]
    M118 gcode_x_offset {offset_x_formatted}
    M118 gcode_y_offset {offset_y_formatted}

# ================================
# CALIBRATION WIZARD
# ================================

[gcode_macro CAMERA_CALIBRATION_WIZARD]
description: Step-by-step calibration wizard
gcode:
    {% set step = params.STEP|default(1)|int %}
    {% set camera_ip = printer["gcode_macro CAMERA_CONFIG"].camera0ip %}
    
    {% if step == 1 %}
        M118 ===== CAMERA CALIBRATION WIZARD - STEP 1 =====
        M118 Setting up for calibration...
        M118 
        G28  # Home all axes
        CHECK_CAMERA
        CAMERA_STREAM_START
        M118 
        M118 Next: Place a ruler or calibration object in view
        M118 Then run: CAMERA_CALIBRATION_WIZARD STEP=2
        
    {% elif step == 2 %}
        M118 ===== CAMERA CALIBRATION WIZARD - STEP 2 =====
        M118 Measure your calibration object...
        M118 
        M118 1. Go to http://{camera_ip}:8080
        M118 2. Enable calibration mode
        M118 3. Measure a known distance in pixels
        M118 4. Calculate and set microns per pixel
        M118 
        M118 Example: If 10mm spans 500 pixels:
        M118   Microns per pixel = (10mm Ã— 1000) / 500 pixels = 20 microns/pixel
        M118 
        M118 Next: Set reference points
        M118 Then run: CAMERA_CALIBRATION_WIZARD STEP=3
        
    {% elif step == 3 %}
        M118 ===== CAMERA CALIBRATION WIZARD - STEP 3 =====
        M118 Setting reference points...
        M118 
        G0 X100 Y100 Z5 F3000
        REPORT_PRINTER_POSITION
        M118 
        M118 Click on the nozzle position in the camera web interface
        M118 Repeat for 2-3 different positions across your bed
        M118 
        M118 Next: Test calibration
        M118 Then run: CAMERA_CALIBRATION_WIZARD STEP=4
        
    {% elif step == 4 %}
        M118 ===== CAMERA CALIBRATION WIZARD - STEP 4 =====
        M118 Testing calibration accuracy...
        M118 
        G0 X150 Y75 Z5 F3000
        REPORT_PRINTER_POSITION
        M118 
        M118 Click on nozzle in web interface - coordinates should match
        M118 If accurate, calibration is complete!
        M118 If not, add more reference points or recalibrate scale
        M118 
        M118 Ready for: CALIBRATE_EXTRUDER_OFFSETS
        
    {% else %}
        M118 Invalid step. Use STEP=1,2,3,or 4
    {% endif %}

# ================================
# CALIBRATION HELP
# ================================

[gcode_macro CAMERA_CALIBRATION_HELP]
description: Show camera calibration help
gcode:
    {% set camera_ip = printer["gcode_macro CAMERA_CONFIG"].camera0ip %}
    M118 
    M118 ===== CAMERA CALIBRATION HELP =====
    M118 
    M118 Quick Start:
    M118   CAMERA_CALIBRATION_WIZARD     - Step-by-step setup
    M118   CALIBRATE_EXTRUDER_OFFSETS    - Auto offset calibration
    M118   TEST_EXTRUDER_OFFSETS         - Test current offsets
    M118 
    M118 Calibration Commands:
    M118   REPORT_PRINTER_POSITION       - Send position to camera
    M118   CAMERA_CAPTURE_WITH_POSITION  - Photo with coordinates
    M118   CAMERA_CALIBRATION_CLEAR      - Reset calibration data
    M118 
    M118 Manual Calculation:
    M118   SET_EXTRUDER_OFFSET_FROM_PIXELS - Calculate from pixel coords
    M118     Usage: SET_EXTRUDER_OFFSET_FROM_PIXELS 
    M118            E0_PIXEL_X=100 E0_PIXEL_Y=200 
    M118            E1_PIXEL_X=105 E1_PIXEL_Y=198 
    M118            MICRONS_PER_PIXEL=15.2
    M118 
    M118 Camera Web Interface: http://{camera_ip}:8080
    M118 
    M118 Process Overview:
    M118   1. Focus camera and measure pixel scale
    M118   2. Set reference points by clicking in image at known positions
    M118   3. Print calibration patterns with both extruders
    M118   4. Click on printed marks to measure offset
    M118   5. Update printer configuration with calculated offsets
    M118 
    M118 Troubleshooting:
    M118   - Ensure klipper_camera_service.py is running
    M118   - Check MQTT connectivity between Klipper Pi and Camera Pi
    M118   - Verify camera is properly focused before calibration